<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mini RAG (Local)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="favicon.svg" type="image/svg+xml" />




</head>
<body>
  <h1>Mini RAG (Local Embeddings)</h1>

  <div class="brand-badge" title="Built by Israa">by Israa ✨</div>

  <section class="card">
  <h2>1) Ingest text</h2>
  <div class="row">
    <textarea id="ingestText" rows="6" placeholder="Paste any text here..."></textarea>

    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
      <input type="file" id="ingestFile" accept=".txt" />
      <button id="ingestBtn">Ingest</button>
    </div>

    <div id="ingestOut" class="muted"></div>
  </div>
</section>


  <section class="card">
    <h2>2) Ask</h2>
    <div class="row">
      <input id="q" placeholder="Ask a question..." />
      <button id="askBtn">Ask</button>
      <div class="row">
      <h3>Top chunks</h3>
      <div id="chunks" class="chunks"></div>
    </div>
      <div class="row">
        <h3>Answer (uses API if available)</h3>
        <div id="answer" class="answer-card"></div>
        <div class="muted">If empty, your API quota is out — retrieval still works above.</div>
      </div>
    </div>
  </section>

 <section class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h2 style="margin:0;">3) Stored chunks</h2>
    <button id="toggleListBtn">Show chunks</button>
  </div>

  <div id="listWrap" class="row hidden"> <!-- starts hidden -->
    <input id="filterChunks" placeholder="Filter preview text..." />
    <button id="listBtn">Refresh</button>
    <div id="listContainer" class="chunks-list" style="margin-top:8px;"></div>
  </div>
</section>




<section class="card">
  <h2>3) Utilities</h2>
  <div class="row">
    <button id="clearBtn">Clear memory</button>
    <button id="exportBtn">Export memory (.json)</button>
  </div>
  <div id="clearOut" class="muted" style="margin-top:8px;"></div> <!-- add this -->
  <div class="row" style="margin-top: 12px;">
    <button id="pingBtn">Ping server</button>
    <div id="pingOut" class="muted"></div>
  </div>
</section>



<script>
    function linkCitations(text) {
  // turns "...[#1] and [#2]" into anchors targeting chunk cards
  return text.replace(/\[#(\d+)\]/g, (_m, n) => {
    const id = `chunk-${n}`;
    return `<a href="#${id}" class="badge">#${n}</a>`;
  });
}

function renderChunks(container, chunks) {
  if (!chunks?.length) { container.textContent = 'No chunks.'; return; }
  container.innerHTML = chunks.map((c, i) => `
    <div class="chunk-card" id="chunk-${i+1}">
      <div class="chunk-title">[#${i+1}] <span class="chunk-score">(score ${c.score})</span></div>
      <div>${c.text.replace(/</g,'&lt;')}</div>
    </div>
  `).join('\n');
}



window.addEventListener('DOMContentLoaded', () => {

    async function postJSON(url, body) {
      const r = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }
    async function getJSON(url) {
      const r = await fetch(url);
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

  async function doIngest(text) {
  const out = document.getElementById('ingestOut');
  if (!text || !text.trim()) {
    out.textContent = 'Nothing to ingest.';
    return;
  }
  out.textContent = `Ingesting ${text.length} chars…`;
  const r = await fetch('/ingest', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ text })
  });
  if (!r.ok) {
    out.textContent = `Server error ${r.status}: ${await r.text()}`;
    return;
  }
  const data = await r.json();
  out.textContent = `Done! Added ${data.chunksAdded} chunks. Total: ${data.totalChunks}`;
}

document.getElementById('ingestBtn').onclick = async () => {
  const fileEl = document.getElementById('ingestFile');
  const out = document.getElementById('ingestOut');

  // 1) Prefer file if selected
  if (fileEl.files && fileEl.files.length > 0) {
    const file = fileEl.files[0];
    if (!file.name.toLowerCase().endsWith('.txt')) {
      out.textContent = 'Only .txt supported right now.';
      return;
    }
    out.textContent = `Reading ${file.name}…`;
    const text = await file.text();
    await doIngest(text);
    fileEl.value = ''; // clear selection
    return;
  }

  // 2) Fallback to textarea
  const text = document.getElementById('ingestText').value;
  await doIngest(text);
};


document.getElementById('askBtn').onclick = async () => {
  const q = document.getElementById('q').value.trim();
  const chunksEl = document.getElementById('chunks');
  const ansEl = document.getElementById('answer');
  if (!q) return;

  chunksEl.textContent = 'Searching...'; ansEl.textContent = '';
  try {
    const res = await getJSON(`/ask?q=${encodeURIComponent(q)}&k=4`);

    // render chunks as small cards with anchors
    renderChunks(chunksEl, res.chunks);

    // beautify answer: link [#1] citations to the chunk cards
    const html = linkCitations(res.answer || '');
    ansEl.innerHTML = html || '<span class="muted">No answer produced.</span>';
  } catch (e) {
    chunksEl.textContent = e.message;
  }

};


document.getElementById('clearBtn').onclick = async () => {
    const r = await fetch('/clear', { method: 'POST' });
    document.getElementById('clearOut').textContent = r.ok ? 'Cleared!' : 'Failed to clear.';
};



//listbtn handler
async function refreshChunks(filter = '') {
  const container = document.getElementById('listContainer');
  container.innerHTML = '<div class="muted">Loading…</div>';
  try {
    const r = await fetch('/list');
    const data = await r.json();
    const items = (data.items || []);
    const filtered = filter
      ? items.filter(it => it.preview.toLowerCase().includes(filter.toLowerCase()))
      : items;

    if (!filtered.length) {
      container.innerHTML = '<div class="muted">No chunks found.</div>';
      return;
    }

    container.innerHTML = filtered.map((it, idx) => `
      <div class="chunk-card">
        <div class="chunk-title">#${it.idx + 1} (id ${it.id})</div>
        <div>${it.preview.replace(/</g,'&lt;')}</div>
      </div>
    `).join('\n');
  } catch (e) {
    container.innerHTML = `<div class="muted">${e.message}</div>`;
  }
}

// --- Stored chunks show/hide
const listWrap = document.getElementById('listWrap');
const toggleListBtn = document.getElementById('toggleListBtn');

// start hidden
listWrap.classList.add('hidden');

toggleListBtn.onclick = () => {
  const nowHidden = listWrap.classList.toggle('hidden');
  toggleListBtn.textContent = nowHidden ? 'Show chunks' : 'Hide chunks';
  if (!nowHidden) {
    // when opening, refresh immediately
    const filt = document.getElementById('filterChunks').value.trim();
    refreshChunks(filt);
  }
};


document.getElementById('listBtn').onclick = () => {
  const filt = document.getElementById('filterChunks').value.trim();
  refreshChunks(filt);
};
document.getElementById('filterChunks').addEventListener('input', (e) => {
  refreshChunks(e.target.value.trim());
});

// initial load once
refreshChunks('');
  


  // Export (already working)
document.getElementById('exportBtn').onclick = async () => {
  const r = await fetch('/export');
  const blob = await r.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'memory.json';
  a.click();
  URL.revokeObjectURL(url);
};


document.getElementById('pingBtn').onclick = async () => {
  const out = document.getElementById('pingOut');
  out.textContent = 'Pinging...';
  try {
    const r = await fetch('/ping');
    out.textContent = r.ok ? 'Server OK ✅' : `Ping failed: ${r.status}`;
  } catch (e) {
    out.textContent = `Ping error: ${e.message}`;
  }
};


}); // end DOMContentLoaded
</script>
</body>
</html>
